### how-to-read-source



### Goal

为什么阅读源码？

动机：

1. 为了学习
2. 为了找bug
3. 为了理解并应用

### Beginning

了解其全貌，了解其架构，了解其应用。然后，从最感兴趣的部分开始。

### Architecture

架构

### Technology Stack

技术栈

### Process Flow

流程

### Design Pattern/Implement

具体实现



### 代码的分类

我通常习惯于以语言去区分源代码，如Javascript, C++, ES6, Befunge, Forth或者LISP。还有另外一种看待源代码的方法，就是基于每一的模块的功能去分类：

- **连接（Glue）**代码
- **接口定义（Interface-defining)**代码
- **实现(Implementation)**代码
- **算法(Algorithmic)**代码
- **配置(Configuration)**代码
- **任务(Tasking)**代码

#### 什么是连接类代码

并不是所有的接口都能很好的工作在一起。**连接类代码是将各模块连在一起的管道**。中间件、绑定回调函数的代码、将参数导入object中或者解析object的代码，这些都属于连接类代码。



关键要弄清楚两个接口是**怎样构建**起来的，以及它们**共通**的地方。

下面的例子来自于 Ben Drucker 的`stream-to-promise`

```javascript
internals.writable = function (stream) {
  return new Promise(function (resolve, reject) {
    stream.once('finish', resolve);
    stream.once('error', reject);
  });
};
```

可以看到，上面两个接口分别是Node的stream和Promise接口。

它们的共同点在于两者完成的时候都会执行一个操作，在Node中通过事件（event）来实现，而在Promise中通过调用resolve函数实现。



#### 什么是接口定义类代码

可能你写过一些只在一两个地方用得到的模块，它们基本是在内部使用的，你不希望有人费很大劲去读这些模块。

而接口定义类代码却是**模块之间的边界线**。



#### 实现类代码

需要在 **“为什么”** 和 **“怎么做”**上作更多说明的地方。

读这类代码的时候应着重思考它是怎样跟更大的整体相融合的。

从公共接口中传入的值是怎样的？哪些需要验证(validation)？包含我们认为该有的值吗？会影响到其他哪些部分？当需要改写以加入新功能的时候会有哪些潜在危险？可能会导致程序崩溃的地方有哪些？有测试代码来对其进行测试吗？变量的生命周期是什么？



#### 算法

算法类代码是实现类代码的一种，通常是封装起来不对外暴露的。它可以说是程序的血肉。也是一款软件的业务逻辑和主进程所在。

**好的注释应该表明为什么要这样做，而不是在做什么**。

算法类代码通常需要更多的解释，因为如果是一个很简单的算法的话，那通常它就已经被吸纳进标准库中了。

在读算法类代码的时候需要关注的事情之一就是其运用的**数据结构**。上面的程序建了一个符号列表，并确保其中没有重复元素。

读的时候同时也要注意有关程序**时间和空间复杂度**的线索。



#### 配置

源代码和配置文件之间的界线非常的窄。对配置文件来说，表达力强、可读性强和直接之间永远是冲突的。

配置类的代码有如下一些值得思考的有趣而独特的**限制**：

- 生命周期
- 机器可写性
- 对一段代码负有责任的人会多很多
- 怎样适用在一些奇怪的地方，比如环境变量
- 往往有涉及安全的敏感信息

#### 任务类

具体业务代码



### 作者意图

**猜测作者意图**有很多的方法。



#### 找异常

```
if (typeof arg != 'number') throw new TypeError("arg must be a number");
```

看上去函数的定义域是数值型。

```
arg = Number(arg)
```

强制转换为数值类型。和前面的一样，只是不再抛出错误。可能会有 `NaN` 出现。



#### 找默认值

```
arg = arg || {}
```

默认为空。

```
arg = (arg == null ? true : arg)
```

如果没有相关参数传进来的话，则默认为 true。



#### 找轨迹（tracing）

有检查点吗？有 debug 日志吗？它们是一个完整的功能，还是之前的 bug 残留下来的呢？



#### 找生命周期

- 被谁初始化的
- 什么时候会改变
- 被谁改变
- 上述信息会在其他地方出现吗
- 会出现不一致性吗

某个时间，某个人输入了一个值。在另外的某个地方，某个时候这个值会对其他人产生影响，他们是谁？是什么或者谁来决定的？这个值会改变吗？由谁来改变？



#### 找隐藏状态机（hidden state machines）

有时候布尔变量会被当作解构了的状态机使用。



#### 找构造（composition）和继承

这段代码有我认识的部分吗？它们有名字吗？



#### 找相同的操作

`map`, `reduce`。